name: Create League Workflow

on:
  workflow_dispatch:
    inputs:
      user_email:
        description: 'User Email'
        required: true
      league_name:
        description: 'League Name'
        required: true
      invitation_code:
        description: 'Invitation Code'
        required: true
      league_id:
        description: 'League ID'
        required: true

jobs:
  send-email:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '14'

      - name: Install dependencies
        run: npm install nodemailer

      - name: Send Invitation Email
        run: node sendEmail.js
        env:
          USER_EMAIL: ${{ github.event.inputs.user_email }}
          LEAGUE_NAME: ${{ github.event.inputs.league_name }}
          INVITATION_CODE: ${{ github.event.inputs.invitation_code }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}

  create-table:
    runs-on: ubuntu-latest
    needs: send-email

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Install Supabase CLI
        run: npm install -g supabase

      - name: Create League Table
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: |
          supabase db copy-table --source-table leaderboard --target-table ${{ github.event.inputs.league_id }}
